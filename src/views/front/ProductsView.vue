<template>
  <div class="main paper">
    <div class="container-fluid px-0 bg-size-cover sushi">
      <div
        class="bg-black w-100 h-100 bg-opacity-25 d-flex justify-content-center align-items-center"
      >
        <div
          class="text-white text-center p-3"
          data-aos="fade-down"
          data-aos-delay="300"
          data-aos-duration="1000"
        >
          <div class="mb-3">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              xmlns:xlink="http://www.w3.org/1999/xlink"
              x="0px"
              y="0px"
              viewBox="0 0 384 384"
              style="enable-background: new 0 0 384 384"
              xml:space="preserve"
              width="48"
            >
              <path
                d="M314.4,283.4c-12.4-11.2-24.5-22.7-37.3-33.4c-28.6-23.9-58.9-45.2-93-60.7c-35.5-16.2-72.7-27.3-110.9-35
	c-22.8-4.6-45.9-7.8-68.9-11.5c-1.1-0.2-2.3,0.6-3.5,1v12c0.2,0.9,0.5,1.9,0.8,2.8c1.8,6,3.5,12.1,5.7,18.1c0.5,1.3,2.6,2.8,4.1,2.9
	c13,1.5,26.1,2.1,39,4c16.1,2.4,32.4,4.7,48.1,8.8c22.9,6,44.3,16.6,65.5,26.9c33.3,16.3,66,33.4,95.1,56.8
	c7.7,6.2,15.9,11.6,24,17.2c2.1,1.4,4.7,2.9,7.1,2.9c10,0,19-3.3,26.9-10.1C316,285.1,315.3,284.2,314.4,283.4z M221,268.4
	c-23.6-13.9-48-26.4-72.5-38.8c-22.8-11.5-46.2-21.9-71.4-27.1c-11.4-2.3-23-3.5-34.9-5.3c-2.4,20.9-2.3,40.7,6.8,59.4
	c1.9,3.8,4.5,7.6,7.7,10.4c21.3,18.3,45.3,32,71.7,41.5c18.3,6.5,37.4,9.7,56.6,11.8c16.3,1.8,32.8,3.1,49.2,3.5
	c15.4,0.4,28.4-6.2,40-16.3c-4.6-3.5-8.9-6.8-13.3-10C247.6,287.6,235.1,276.7,221,268.4z M162.2,152.1c0.6,3.9-0.3,8.9,1.8,11.5
	c2.3,2.8,7.3,3.2,11,4.9c10.8,5.1,21.9,8.8,34.6,9.3c0.2-3.1,0.8-6.2,0.5-9.3c-1.9-18.9-3.5-37.9-6.3-56.8
	c-1.9-12.4-5.7-24.4-8.6-36.6c-0.7-2.7-2.1-4.4-5.2-4.9c-11.1-2-22.2-4.5-33.4-6.4c-6.9-1.2-13.9-1.8-21.2-2.7
	c0.3,1.1,0.4,1.4,0.6,1.7C149.4,91.2,157.1,121.3,162.2,152.1z M224.7,180.7c16.5,4.8,32.8,9.6,49.6,14.5c0-3.4,0.3-6.6-0.1-9.8
	c-1.9-16.6-3.4-33.2-6-49.7c-2-12.6-5.5-25-8.6-37.5c-0.5-2-1.8-4.3-3.5-5.3c-13.3-7.5-27.6-12.5-42.3-16.6c-0.5-0.1-1.1,0-1.7,0
	C224.1,128.6,225.9,143.3,224.7,180.7z M289.4,201.1c14,6.2,28,12.4,42,18.7c0.1-0.6,0.3-1.2,0.4-1.8c2.1-24.5,1.9-49.1-1.4-73.5
	c-0.2-1.5-1.4-3.2-2.6-4.1c-10.3-7.8-20.7-15.6-31.2-23.2c-5.7-4.1-11.8-7.8-18.5-12.2C285,137.3,291.5,168.7,289.4,201.1z
	 M110.2,145.1c0.3,0.9,1.2,2,2.1,2.3c11.5,3.5,23.1,6.9,35.2,10.5c-4.4-25.7-10.2-50.5-19.3-74.4c-2.7-6.9-6.4-13.4-9.9-20.1
	c-0.6-1.1-2.2-2.5-3.3-2.4c-3.6,0.2-7.3,0.4-10.6,1.7c-10.9,4.1-20.2,11.1-29.6,17.6c0.1,0.5,0.1,0.6,0.2,0.7
	C90.7,100.1,102,121.7,110.2,145.1z M329.6,276.4c6-3.2,20.5-18.3,25.3-26.3c-37-20.1-74.9-37.8-115.8-48.6
	C271.8,223.6,301.7,248.9,329.6,276.4z M61.6,89.4c-16.2,12.8-32,25.3-48.2,38.2c26.8,4.8,52.9,9.4,79.2,14.1
	C84.1,123.4,75.8,105,61.6,89.4z M383,194.1c-9.9-13.7-22.2-25.1-35.5-37.2c1.8,23.9,1.6,46.5-0.8,69.1c-0.1,0.8,0.7,2.1,1.4,2.6
	c5.3,3,10.7,5.8,16.6,8.9c4.2-7.4,8.7-14.4,12.4-21.8c2.7-5.3,4.5-11,6.3-16.7C384.1,197.6,383.9,195.3,383,194.1z"
                style="fill: #fff"
              />
            </svg>
          </div>
          <h3 class="h2">寿司を浸すためのヒント</h3>
          <p class="mb-0">
            まず寿司を少し逆さまにしてから、具材の先を使って少量の醤油をつけます。
          </p>
        </div>
      </div>
    </div>
    <div
      :class="{
        container: detectWidth >= 992,
        'container-fluid': detectWidth < 992,
      }"
    >
      <div class="row py-lg-5">
        <div class="col-lg-3 nav-parent mb-5 mb-lg-3 px-0 px-lg-3">
          <div class="nav-pills-sticky">
            <div
              class="nav nav-pills flex-nowrap bg-dark"
              :class="{
                'flex-column': detectWidth >= 992,
                'w-max-content': detectWidth < 992,
              }"
            >
              <button
                type="button"
                class="nav-link getSushi active"
                data-bs-toggle="pill"
                @click="getProducts('', 1)"
              >
                ぜんぴん
              </button>
              <button
                type="button"
                class="nav-link getSushi"
                data-bs-toggle="pill"
                v-for="(category, idx) in categories"
                :key="`category_${idx}`"
                @click="getProducts(categories[idx], 1)"
              >
                {{ category }}
              </button>
              <button
                type="button"
                class="nav-link getSushi border-lg-top border-4 text-light-yellow"
                data-bs-toggle="pill"
                @click="getSpecialPrice"
              >
                特別価格
              </button>
            </div>
            <p class="fs-8 text-secondary mt-2 d-none d-lg-block">
              * 写真はカルテからのもので、作品としてのみ使用されています
            </p>
          </div>
        </div>
        <div class="col-lg-9 detect-width">
          <div
            class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-3 mb-5"
          >
            <div class="col" v-for="item in products" :key="item.id">
              <div class="card sushi-card">
                <router-link :to="`/prod/${item.id}`">
                  <div class="img-cover text-center">
                    <img
                      :src="item.imageUrl"
                      class="card-img-top object-fit-cover w-75"
                      alt="item.title"
                    />
                    <span
                      v-if="item.origin_price !== item.price"
                      class="badge rounded-pill bg-deep-red px-1 py-2 position-absolute vrl-text ls-xl"
                      style="height: auto; left: 1rem; top: 1rem"
                    >
                      特別価格
                    </span>
                  </div>
                  <div class="card-body">
                    <h4 class="h5 card-title text-truncate">
                      {{ item.title }}
                    </h4>
                    <p class="card-text text-truncate">
                      {{ item.description }}
                    </p>
                  </div>
                </router-link>
                <div class="card-footer border-top-0 pb-3">
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <p v-if="item.price === item.origin_price" class="mb-0">
                      <span class="align-top">¥ </span>
                      <b class="fs-4">{{ $filters.thousandths(item.price) }}</b>
                    </p>
                    <div v-else class="lh-sm text-end">
                      <del class="text-secondary fs-7">
                        {{ $filters.currencyJPY(item.origin_price) }}
                      </del>
                      <p class="mb-0">
                        <span class="fw-bold text-danger">
                          <span class="align-top">¥ </span>
                          <b class="fs-4">
                            {{ $filters.thousandths(item.price) }}
                          </b>
                        </span>
                      </p>
                    </div>
                    <div class="d-flex align-items-center">
                      <button
                        type="button"
                        class="btn py-0 favorite-btn"
                        :ref="item.id"
                        :title="
                          favoriteProdId.includes(item.id)
                            ? '私のお気に入りの解除する'
                            : '私のお気に入りに追加'
                        "
                        @click="toggleFavorite(item.id)"
                      >
                        <i
                          v-if="favoriteProdId.includes(item.id)"
                          class="bi bi-balloon-heart-fill text-danger fs-2"
                        ></i>
                        <i v-else class="bi bi-balloon-heart fs-2"></i>
                      </button>
                      <div
                        class="addToCart btn btn-dark rounded-circle text-white d-flex justify-content-center align-items-center"
                        style="width: 45px; height: 45px"
                        @click="addCart(item.id)"
                        :disabled="isLoading === item.id"
                      >
                        <div
                          v-if="isLoading === item.id"
                          class="spinner-border spinner-border-sm"
                          role="status"
                        >
                          <span class="visually-hidden">Loading...</span>
                        </div>
                        <i v-else class="bi bi-plus-lg fs-5"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <PageComp
            v-if="categoryName !== '特別価格'"
            :pages="pagination"
            @emit-page="getProducts(categoryName, $event), toTop(440)"
          ></PageComp>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import PageComp from "@/components/PageComp";
import emitter from "@/utility/emitter.js";

export default {
  data() {
    return {
      products: [],
      tempProducts: [],
      categories: ["握り寿司", "海苔巻き", "裏巻き", "刺身"],
      categoryName: "",
      pagination: {},
      isLoading: "",
      favoriteProdId: JSON.parse(localStorage.getItem("itemId")) || [],
    };
  },
  props: ["detectWidth"],
  inject: ["emitter"],
  components: {
    PageComp,
  },
  methods: {
    getProducts(category, page = 1) {
      this.categoryName = category;
      let loader = this.$loading.show();
      let url = `${process.env.VUE_APP_API}/api/${process.env.VUE_APP_PATH}/products?page=${page}`;
      if (category) {
        url = `${process.env.VUE_APP_API}/api/${process.env.VUE_APP_PATH}/products?category=${category}&page=${page}`;
      }

      this.$http
        .get(url)
        .then((res) => {
          loader.hide();
          this.products = res.data.products;
          // 分頁
          this.pagination = res.data.pagination;
        })
        .catch((err) => {
          loader.hide();
          console.dir(err);
        });
    },
    // 取得特價商品
    getSpecialPrice() {
      let loader = this.$loading.show();
      this.$http
        .get(
          `${process.env.VUE_APP_API}/api/${process.env.VUE_APP_PATH}/products/all`
        )
        .then((res) => {
          loader.hide();
          this.tempProducts = res.data.products;
          this.products = this.tempProducts.filter(
            (item) => item.price !== item.origin_price
          );
          this.categoryName = "特別価格";
        });
    },
    // 加入購物車
    addCart(id, qty = 1) {
      this.isLoading = id;
      const data = {
        product_id: id,
        qty,
      };
      this.$http
        .post(
          `${process.env.VUE_APP_API}/api/${process.env.VUE_APP_PATH}/cart`,
          { data }
        )
        .then((res) => {
          this.isLoading = "";
          // 給 navigation 選單用的
          emitter.emit("get-cart");

          // 全域的 emitter
          this.emitter.emit("toast-message", {
            style: "success",
            content: res.data.message,
          });
        })
        .catch((err) => {
          // console.dir(err);
          this.isLoading = "";
          this.emitter.emit("toast-message", {
            style: "error",
            content: err.response.data.message,
          });
        });
    },
    // 加入／取消 我的最愛
    toggleFavorite(id) {
      const itemIdx = this.favoriteProdId.findIndex((item) => item === id);
      if (itemIdx === -1) {
        this.favoriteProdId.push(id);
      } else {
        this.favoriteProdId.splice(itemIdx, 1);
      }
      // 存入 localStorage
      localStorage.setItem("itemId", JSON.stringify(this.favoriteProdId));

      // 點擊加入動畫
      this.$refs[`${id}`][0].classList.add("active");
      setTimeout(() => {
        this.$refs[`${id}`][0].classList.remove("active");
      }, 600);
    },
    // 回壽司頂部
    toTop(val = 0) {
      window.scrollTo({
        top: val,
        behavior: "smooth",
      });
    },
  },
  mounted() {
    this.getProducts();
    this.toTop(0);

    // 篩選切換 頁面回壽司頂部
    document.querySelectorAll(".getSushi").forEach((e) => {
      e.addEventListener("click", () => {
        setTimeout(() => {
          this.toTop(440);
        }, 200);
      });
    });
  },
};
</script>

<style lang="scss" scoped>
.sushi {
  background: url("https://images.unsplash.com/photo-1617196034564-65baf56380ab?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=3616&q=80")
    center center no-repeat;
  height: 440px;
}

// 壽司選單
.nav-pills-sticky {
  position: sticky;
  top: 126px;
  z-index: 3;
}
.nav-pills {
  display: flex;
  .nav-link.getSushi {
    flex-shrink: 0;
    padding: 1rem;
    color: #fff;
    &:hover {
      background-color: var(--bs-light-green);
    }
  }
}
@media (max-width: 991.98px) {
  .detect-width {
    max-width: 720px;
    margin: auto;
  }
  .nav-pills-sticky {
    overflow-x: scroll;
    background-color: var(--bs-dark);
  }
  .nav-parent {
    position: sticky;
    top: 64px;
    z-index: 4;
  }
  .nav-link.getSushi {
    &:hover {
      background-color: transparent !important;
    }
    &.active {
      background-color: var(--bs-light-green) !important;
    }
  }
}
@media (max-width: 509.98px) {
  .nav-parent {
    &::before {
      font-family: "bootstrap-icons" !important;
      content: "\F231" !important;
      color: var(--bs-gray-300);
      position: absolute;
      width: 2rem;
      height: 100%;
      right: 0;
      font-size: 1rem;
      text-align: center;
      line-height: 3.7rem;
      background: linear-gradient(to right, transparent, var(--bs-dark));
      z-index: 4;
    }
    .nav-pills {
      padding-right: 2rem;
    }
  }
}
</style>
